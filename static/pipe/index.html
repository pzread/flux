<!DOCTYPE html>
<html>
<head>
<title>Flux</title>
<link rel="stylesheet" type="text/css" href="index.css">
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script type="text/javascript" src="/lib/hashids.min.js"></script>
<script type="text/javascript" src="config.js"></script>
<script type="text/javascript">
'use strict'

let crypto = window.crypto || window.msCrypto;
let hasher = new Hashids();

function gen_token() {
    let rnd = new Uint8Array(3);
    crypto.getRandomValues(rnd);
    return hasher.encode(Array.from(rnd));
}

function require() {
    let defer = $.Deferred();
    function try_require() {
        let token = gen_token();
        $.post(FLUX_SERVER + "/require/" + token + '/1').done((res) => {
            if(res == "duplicate") {
                try_require();
            }
            defer.resolve(token, res);
        });
    }
    try_require();
    return defer.promise();
}

$(document).ready(() => {
    function add_item() {
        let j_item = $('div.origin').clone(true);
        let j_transmit = j_item.find('.transmit');
        let j_file = j_item.find('.file');
        let j_link = j_item.find('.link')
        let j_result = j_item.find('.result');

        j_transmit.click((evt) => {
            if(!j_transmit.hasClass("box-plus")) {
                return;
            }
            j_file.trigger("click");
        });
        j_file.change((evt) => {
            add_item();

            j_transmit.removeClass("box-plus");
            j_transmit.addClass("box-spin");
            j_transmit.find(".text").hide();

            require().done((token, channel) => {
                let file = evt.target.files[0];
                let req = new XMLHttpRequest();

                let link = FLUXCDN_SERVER + "/pull/" + token + "/" + file.name;
                j_link.attr("href", link);
                j_link.text(link);
                j_link.show();
                j_link.css("opacity", "1");

                let counter = 0;
                req.upload.onprogress = (evt) => {
                    if(evt.loaded / evt.total < 0.01) {
                        return;
                    }
                    if(counter <= 20) {
                        counter += 1;
                        return;
                    }
                    if(j_transmit.hasClass("box-spin")) {
                        j_link.hide();
                        j_transmit.find(".prog").show();
                        j_transmit.removeClass("box-spin");
                        j_transmit.css("width", "60%");
                    }
                    j_transmit.find(".prog").css("background-size",
                            evt.loaded * 100 / evt.total + "% 100%");
                };
                req.onload = (evt) => {
                    j_link.hide();
                    j_transmit.removeClass("box-spin");

                    let resp = req.responseText;
                    if(resp == "ok"){
                        j_transmit.addClass("box-succ");
                        j_result.text(resp);
                    } else {
                        j_transmit.addClass("box-fail");
                        j_result.text(resp);
                    }

                    j_transmit.css("width", "");
                    j_transmit.find(".prog").hide();
                    j_result.css("opacity", "1");
                }
                req.open("POST", FLUX_SERVER + "/push/" + channel, "true");
                req.send(file);
            });
        });

        j_item.removeClass("origin hide");
        $("#container").append(j_item);
    }

    add_item();
});

</script>
</head>
<body>
<div class="origin hide item">
    <div class="transmit button box box-plus">
        <div class="text">Transmit</div>
        <div class="prog hide"></div>
    </div>
    <a class="link"></a>
    <div class="result"></div>
    <input type="file" class="file hide" />
</div>
<div id="container"></div>
</body>
</html>
